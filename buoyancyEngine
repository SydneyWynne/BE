import RPi.GPIO as GPIO
import time 

servo = 19 #servo pin
GPIO.setmode(GPIO.BCM)
GPIO.setup(servo,GPIO.OUT)
pwm = GPIO.PWM(servo, 50)
pwm.start(0)

switch = 13 # pin
GPIO.setup(switch, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)
trip = GPIO.input(switch)

def liquidSensor(): #########################

    sensorOut = 7

    GPIO.setmode(GPIO.BCM)
    GPIO.setup(sensorOut, GPIO.IN)

    while True:
        isDry = GPIO.input(sensorOut)
        if (isDry):
            print("dry")
            return 1
        else:
            print("wet")
            return 0
        
    time.sleep(3)
    
def sonarSensor(): ########################
    
    TRIG = 21
    ECHO = 20
    GPIO.setmode(GPIO.BCM)
    
    while True:
        print("distance measurement in progress")
        GPIO.setup(TRIG, GPIO.OUT)
        GPIO.setup(ECHO, GPIO.IN)
        GPIO.output(TRIG, False)
        
        print("waiting for sensor to settle")
        time.sleep(0.2)
        GPIO.output(TRIG, True)
        time.sleep(0.00001)
        GPIO.output(TRIG, False)
        
        while GPIO.input(ECHO) == 0:
            pulse_start = time.time()
            
        while GPIO.input(ECHO) == 1:
            pulse_end = time.time()
            
        pulse_duration = pulse_end - pulse_start
        distance = pulse_duration * 17150               ###17150 for air, 740 water
        distance = round(distance, 2)
        print("distance: ", distance, "cm")
        
        time.sleep(2)  
        
        return distance

    
def waterIn():                          ###turn counterclockwise

    GPIO.setmode(GPIO.BCM)
    #GPIO.setup(servo,GPIO.OUT)
    #pwm = PWM.GPIO(servo, 50)
    #pwm.start()
    print("activating servo up")
    i = 0
    while i <1:
        trip = GPIO.input(switch)
        if (trip == 0):
            pwm.ChangeDutyCycle(5)
        else:
            pwm.ChangeDutyCycle(0)
            i = i + 1
    
    
def waterOut():                         ###turn clockwise

    GPIO.setmode(GPIO.BCM)
    #GPIO.setup(servo,GPIO.OUT)
    #pwm = PWM.GPIO(servo, 50)
    #pwm.start()
    pwm.ChangeDutyCycle(10)
    print("activating servo down")
    time.sleep(33)
    pwm.ChangeDutyCycle(0)
    
    
def main():
    
    count = 0
    
    #sinks down when deployed
    #goes up
    # COUNT = 1 - goes down
    #goes up
    # COUNT = 2 - goes down
    
    while (count < 3):
        
        if (sonarSensor() < 3):
            waterOut()
            time.sleep(30)
            
        if (liquidSensor() == 1):
            waterIn()                      #servo up
            count = count + 1
            time.sleep(30)
            
    if (count == 3):
        
        print("end")
        count = count + 1               #ends on top, floating
    
    
    GPIO.cleanup()
   
#program starts
waterIn()     
waterOut()

while True:
    if (liquidSensor() == 0):                            #starts plunger @ bottom
        waterIn()                                     
        main()
        break
    time.sleep(3)
    
GPIO.cleanup()

